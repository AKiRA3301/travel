<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>æ—…è¡ŒåŸºé‡‘ - Kiki & Luis</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif; }
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
    @keyframes gradient { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const SUPABASE_URL = 'https://rmsxbcifpzgtjetoycyj.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_8SBnDUYD0Cr8Ql52MBt2hQ_zBT6y6OW'; 
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const categories = [
      { id: 'daigou', name: 'ä»£è´­', emoji: 'ğŸ›ï¸' },
      { id: 'salary', name: 'å·¥èµ„', emoji: 'ğŸ’°' },
      { id: 'bonus', name: 'å¥–é‡‘', emoji: 'ğŸ' },
      { id: 'hongbao', name: 'çº¢åŒ…', emoji: 'ğŸ§§' },
      { id: 'parttime', name: 'å…¼èŒ', emoji: 'ğŸ’¼' },
      { id: 'sell', name: 'é—²ç½®å‡ºå”®', emoji: 'ğŸ“¦' },
      { id: 'other', name: 'å…¶ä»–', emoji: 'âœ¨' },
    ];

    const users = [
      { id: 'luis', name: 'Luis', color: '#6B9DFC', emoji: 'ğŸ‘¦' },
      { id: 'kiki', name: 'Kiki', color: '#FF8A9B', emoji: 'ğŸ‘§' },
    ];

    function App() {
      const [trips, setTrips] = useState([]);
      const [currentTripId, setCurrentTripId] = useState(null);
      const [isLoading, setIsLoading] = useState(true);
      const [showAddForm, setShowAddForm] = useState(false);
      const [showTripForm, setShowTripForm] = useState(false);
      const [showTripList, setShowTripList] = useState(false);
      const [newRecord, setNewRecord] = useState({ category: 'daigou', user: 'luis', amount: '', note: '', date: new Date().toISOString().split('T')[0] });
      const [newTrip, setNewTrip] = useState({ destination: '', amount: 10000 });

      const loadData = async () => {
        const { data } = await supabaseClient.from('trips').select('*').order('id', { ascending: false });
        if (data) {
          setTrips(data);
          if (data.length > 0 && !currentTripId) setCurrentTripId(data[0].id);
        }
        setIsLoading(false);
      };

      useEffect(() => {
        loadData();
        const sub = supabaseClient.channel('realtime').on('postgres_changes', { event: '*', schema: 'public', table: 'trips' }, () => loadData()).subscribe();
        return () => supabaseClient.removeChannel(sub);
      }, []);

      const currentTrip = trips.find(t => t.id === currentTripId);
      const records = currentTrip?.records || [];
      const totalSaved = records.reduce((sum, r) => sum + Number(r.amount), 0);
      const progress = currentTrip ? Math.min((totalSaved / currentTrip.target_amount) * 100, 100) : 0;

      const handleAddTrip = async () => {
        if (!newTrip.destination || !newTrip.amount) return;
        await supabaseClient.from('trips').insert([{ id: Date.now(), destination: newTrip.destination, target_amount: Number(newTrip.amount), records: [] }]);
        setShowTripForm(false);
        setNewTrip({ destination: '', amount: 10000 });
      };

      const handleAddRecord = async () => {
        if (!newRecord.amount || !currentTrip) return;
        const record = { ...newRecord, id: Date.now(), amount: Number(newRecord.amount) };
        const updatedRecords = [record, ...records];
        await supabaseClient.from('trips').update({ records: updatedRecords }).eq('id', currentTripId);
        setShowAddForm(false);
        setNewRecord({ ...newRecord, amount: '', note: '' });
      };

      const handleDeleteRecord = async (recordId) => {
        const updated = records.filter(r => r.id !== recordId);
        await supabaseClient.from('trips').update({ records: updated }).eq('id', currentTripId);
      };

      if (isLoading) return (
        <div style={styles.loadingContainer}><div style={styles.loadingPlane}>âœˆï¸</div><p style={styles.loadingText}>æ­£åœ¨è¿æ¥äº‘ç«¯...</p></div>
      );

      return (
        <div style={styles.container}>
          {/* Header */}
          <header style={styles.header}>
            <div style={styles.headerContent}>
              <div style={styles.titleRow}>
                <span style={styles.titlePlane}>âœˆï¸</span>
                <div style={styles.titleText}><h1 style={styles.title}>æ—…è¡ŒåŸºé‡‘</h1><p style={styles.titleEn}>Travel Fund</p></div>
              </div>
              <p style={styles.subtitle}><span style={styles.subtitleText}>Kiki & Luis ä¸€èµ·æ”’é’±å»æ—…è¡Œ</span></p>
            </div>
          </header>

          {/* Trip Selector */}
          <section style={styles.tripSelector}>
            <button style={styles.tripButton} onClick={() => setShowTripList(true)}>
              <span style={styles.tripIcon}>ğŸ—ºï¸</span>
              <span style={styles.tripName}>{currentTrip ? currentTrip.destination : 'é€‰æ‹©è®¡åˆ’'}</span>
              <span style={styles.tripArrow}>â–¼</span>
            </button>
            <button style={styles.addTripBtn} onClick={() => setShowTripForm(true)}>+ æ–°è®¡åˆ’</button>
          </section>

          {currentTrip ? (
            <>
              {/* Progress Card */}
              <section style={styles.progressSection}>
                <div style={styles.progressCard}>
                  <div style={styles.progressHeader}><span style={styles.progressLabel}>å‚¨è“„è¿›åº¦</span><span style={styles.progressPercent}>{progress.toFixed(1)}%</span></div>
                  <div style={styles.progressBarBg}>
                    <div style={{...styles.progressBarFill, width: `${progress}%`}}><div style={styles.progressShine}></div></div>
                    <div style={{...styles.progressPlane, left: `calc(${Math.min(progress, 92)}% - 10px)`}}>âœˆï¸</div>
                  </div>
                  <div style={styles.amountRow}>
                    <div style={styles.amountItem}><span style={styles.amountLabel}>å·²å­˜</span><span style={styles.amountValue}>Â¥{totalSaved.toLocaleString()}</span></div>
                    <div style={styles.amountDivider}>â†’</div>
                    <div style={styles.amountItem}><span style={styles.amountLabel}>ç›®æ ‡</span><span style={styles.amountValue}>Â¥{currentTrip.target_amount.toLocaleString()}</span></div>
                  </div>
                </div>
              </section>

              {/* Users */}
              <section style={styles.userSection}>
                <h2 style={styles.sectionTitle}>ğŸ’ª è´¡çŒ®æ¦œ</h2>
                <div style={styles.userCards}>
                  {users.map(user => {
                    const amount = records.filter(r => r.user_id === user.id).reduce((s, r) => s + r.amount, 0);
                    const percent = totalSaved > 0 ? (amount / totalSaved) * 100 : 0;
                    return (
                      <div key={user.id} style={styles.userCard}>
                        <div style={styles.userAvatarContainer}>{user.emoji}</div>
                        <div style={styles.userInfo}><span style={styles.userName}>{user.name}</span><span style={styles.userAmount}>Â¥{amount.toLocaleString()}</span></div>
                        <div style={styles.userBarContainer}><div style={{...styles.userBar, width: `${percent}%`, backgroundColor: user.color}}></div></div>
                        <span style={{...styles.userPercent, color: user.color}}>{percent.toFixed(0)}%</span>
                      </div>
                    );
                  })}
                </div>
              </section>

              {/* Records */}
              <section style={styles.recordsSection}>
                <div style={styles.recordsHeader}><h2 style={styles.sectionTitle}>ğŸ“‹ æ”¶å…¥è®°å½•</h2><span style={styles.recordCount}>{records.length} æ¡</span></div>
                <div style={styles.recordsList}>
                  {records.map(r => {
                    const cat = categories.find(c => c.id === r.category);
                    return (
                      <div key={r.id} style={styles.recordItem}>
                        <div style={styles.recordIcon}>{cat?.emoji}</div>
                        <div style={styles.recordInfo}>
                          <div style={styles.recordMain}><span style={styles.recordCategory}>{cat?.name}</span><span style={{...styles.recordUser, color: users.find(u=>u.id===r.user_id)?.color}}>{r.user_id === 'luis' ? 'ğŸ‘¦ Luis' : 'ğŸ‘§ Kiki'}</span></div>
                          <div style={styles.recordMeta}>{r.note && <span style={styles.recordNote}>{r.note}</span>}<span>{r.date}</span></div>
                        </div>
                        <div style={styles.recordRight}><span style={styles.recordAmount}>+Â¥{r.amount}</span><button style={styles.deleteBtn} onClick={() => handleDeleteRecord(r.id)}>Ã—</button></div>
                      </div>
                    );
                  })}
                </div>
              </section>
            </>
          ) : <div style={{textAlign:'center', marginTop: 100}}>è¿˜æ²¡æœ‰æ—…è¡Œè®¡åˆ’</div>}

          {/* Fab */}
          {currentTrip && <button style={styles.addButton} onClick={() => setShowAddForm(true)}><span style={styles.addButtonIcon}>+</span>è®°ä¸€ç¬”</button>}

          {/* Modal: Add Record */}
          {showAddForm && (
            <div style={styles.modalOverlay} onClick={() => setShowAddForm(false)}>
              <div style={styles.modal} onClick={e => e.stopPropagation()}>
                <h3 style={styles.modalTitle}>æ·»åŠ æ”¶å…¥ ğŸ’°</h3>
                <div style={styles.userSelector}>
                  {users.map(u => (
                    <button key={u.id} style={{...styles.userSelectBtn, borderColor: newRecord.user === u.id ? u.color : '#eee'}} onClick={() => setNewRecord({...newRecord, user: u.id})}>
                      <span style={{fontSize: 24}}>{u.emoji}</span><span style={styles.userSelectName}>{u.name}</span>
                    </button>
                  ))}
                </div>
                <div style={styles.categoryGrid}>
                  {categories.map(cat => (
                    <button key={cat.id} style={{...styles.categoryBtn, ...(newRecord.category === cat.id ? styles.categoryBtnActive : {})}} onClick={() => setNewRecord({...newRecord, category: cat.id})}>
                      <span>{cat.emoji}</span><span style={styles.categoryBtnText}>{cat.name}</span>
                    </button>
                  ))}
                </div>
                <input type="number" placeholder="é‡‘é¢" style={styles.inputFull} value={newRecord.amount} onChange={e => setNewRecord({...newRecord, amount: e.target.value})} />
                <input type="text" placeholder="å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰" style={styles.inputFull} value={newRecord.note} onChange={e => setNewRecord({...newRecord, note: e.target.value})} />
                <button style={styles.confirmBtn} onClick={handleAddRecord}>ç¡®è®¤æ·»åŠ </button>
              </div>
            </div>
          )}

          {/* Modal: Add Trip */}
          {showTripForm && (
            <div style={styles.modalOverlay} onClick={() => setShowTripForm(false)}>
              <div style={styles.modal} onClick={e => e.stopPropagation()}>
                <h3 style={styles.modalTitle}>æ–°å»ºæ—…è¡Œè®¡åˆ’ ğŸŒŸ</h3>
                <input type="text" placeholder="ç›®çš„åœ°" style={styles.inputFull} value={newTrip.destination} onChange={e => setNewTrip({...newTrip, destination: e.target.value})} />
                <input type="number" placeholder="ç›®æ ‡é‡‘é¢" style={styles.inputFull} value={newTrip.amount} onChange={e => setNewTrip({...newTrip, amount: e.target.value})} />
                <button style={styles.confirmBtn} onClick={handleAddTrip}>åˆ›å»ºè®¡åˆ’</button>
              </div>
            </div>
          )}

          {/* Modal: Trip List */}
          {showTripList && (
            <div style={styles.modalOverlay} onClick={() => setShowTripList(false)}>
              <div style={styles.modal} onClick={e => e.stopPropagation()}>
                <h3 style={styles.modalTitle}>é€‰æ‹©è®¡åˆ’ ğŸ—ºï¸</h3>
                {trips.map(t => (
                  <div key={t.id} style={{...styles.tripListItem, background: t.id === currentTripId ? '#f0f7ff' : '#fff'}} onClick={() => {setCurrentTripId(t.id); setShowTripList(false)}}>
                    <span>ğŸ“ {t.destination}</span><span>Â¥{t.target_amount}</span>
                  </div>
                ))}
                <button style={styles.modalCloseBtn} onClick={() => setShowTripList(false)}>å…³é—­</button>
              </div>
            </div>
          )}
        </div>
      );
    }

    const styles = {
      container: { minHeight: '100vh', background: 'linear-gradient(135deg, #E8F4F8 0%, #F0E6FA 50%, #FFF0F5 100%)', paddingBottom: '100px' },
      loadingContainer: { minHeight: '100vh', display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center' },
      loadingPlane: { fontSize: '48px', animation: 'bounce 1s infinite' },
      loadingText: { marginTop: '16px', color: '#6B7B8A' },
      header: { padding: '32px 20px 24px' },
      titleRow: { display: 'flex', alignItems: 'center', gap: '12px' },
      titlePlane: { fontSize: '36px', filter: 'drop-shadow(0 4px 8px rgba(107, 157, 252, 0.3))' },
      title: { fontSize: '28px', fontWeight: '800', background: 'linear-gradient(135deg, #6B9DFC 0%, #FF8A9B 100%)', WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent' },
      titleEn: { fontSize: '11px', color: '#9BA5B0', letterSpacing: '3px', textTransform: 'uppercase' },
      subtitle: { marginTop: '8px', padding: '8px 14px', background: 'rgba(255,255,255,0.6)', backdropFilter: 'blur(10px)', borderRadius: '20px', width: 'fit-content' },
      subtitleText: { fontSize: '13px', color: '#7B8794' },
      tripSelector: { display: 'flex', gap: '12px', padding: '0 20px 20px' },
      tripButton: { flex: 1, display: 'flex', alignItems: 'center', gap: '10px', padding: '14px 16px', background: 'rgba(255,255,255,0.7)', borderRadius: '16px', border: '1px solid #fff', textAlign: 'left' },
      addTripBtn: { padding: '14px 18px', background: 'linear-gradient(135deg, #6B9DFC 0%, #8B7BF7 100%)', color: '#FFF', border: 'none', borderRadius: '16px', fontWeight: 'bold' },
      progressSection: { padding: '0 20px 20px' },
      progressCard: { background: 'rgba(255,255,255,0.75)', backdropFilter: 'blur(20px)', borderRadius: '24px', padding: '24px', boxShadow: '0 8px 32px rgba(0,0,0,0.05)' },
      progressHeader: { display: 'flex', justifyContent: 'space-between', marginBottom: '14px' },
      progressPercent: { fontSize: '28px', fontWeight: '800', color: '#6B9DFC' },
      progressBarBg: { height: '32px', background: 'rgba(0,0,0,0.05)', borderRadius: '16px', position: 'relative' },
      progressBarFill: { height: '100%', background: 'linear-gradient(90deg, #6B9DFC, #FF8A9B)', borderRadius: '16px', transition: 'width 0.8s ease' },
      progressPlane: { position: 'absolute', top: '-6px', fontSize: '28px' },
      amountRow: { display: 'flex', justifyContent: 'center', gap: '24px', marginTop: '20px' },
      amountValue: { fontSize: '22px', fontWeight: 'bold' },
      userSection: { padding: '0 20px 20px' },
      sectionTitle: { fontSize: '16px', fontWeight: 'bold', marginBottom: '12px' },
      userCard: { display: 'flex', alignItems: 'center', padding: '12px 16px', background: 'rgba(255,255,255,0.7)', borderRadius: '16px', marginBottom: '10px' },
      userAvatarContainer: { width: 44, height: 44, background: '#fff', borderRadius: '50%', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 24 },
      userInfo: { flex: 1, marginLeft: 12 },
      userName: { display: 'block', fontSize: '14px', fontWeight: 'bold' },
      userBarContainer: { width: '60px', height: '6px', background: '#eee', borderRadius: '3px' },
      userBar: { height: '100%', borderRadius: '30px' },
      userPercent: { width: 45, textAlign: 'right', fontWeight: 'bold' },
      recordsSection: { padding: '0 20px' },
      recordsList: { background: 'rgba(255,255,255,0.7)', borderRadius: '20px', overflow: 'hidden' },
      recordItem: { display: 'flex', alignItems: 'center', padding: '14px 16px', borderBottom: '1px solid #f0f0f0' },
      recordIcon: { width: 42, height: 42, background: '#f5f7fa', borderRadius: '14px', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 20 },
      recordInfo: { flex: 1, marginLeft: 12 },
      recordCategory: { fontWeight: 'bold', fontSize: '14px' },
      recordUser: { fontSize: '12px', marginLeft: 8 },
      recordMeta: { fontSize: '12px', color: '#999' },
      recordAmount: { color: '#48BB78', fontWeight: 'bold' },
      deleteBtn: { border: 'none', background: 'none', color: '#ff6b6b', padding: '0 5px' },
      addButton: { position: 'fixed', bottom: '24px', left: '50%', transform: 'translateX(-50%)', padding: '16px 32px', background: 'linear-gradient(135deg, #6B9DFC, #FF8A9B)', color: '#fff', border: 'none', borderRadius: '50px', fontWeight: 'bold', boxShadow: '0 8px 32px rgba(107,157,252,0.4)' },
      modalOverlay: { position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.5)', backdropFilter: 'blur(5px)', display: 'flex', alignItems: 'flex-end', justifyContent: 'center', zIndex: 100 },
      modal: { width: '100%', maxWidth: '500px', background: '#fff', padding: '24px', borderRadius: '24px 24px 0 0' },
      modalTitle: { textAlign: 'center', marginBottom: '20px' },
      userSelector: { display: 'flex', gap: '12px', marginBottom: '20px' },
      userSelectBtn: { flex: 1, padding: '16px', border: '2px solid #eee', borderRadius: '16px', background: '#fff', display: 'flex', flexDirection: 'column', alignItems: 'center' },
      categoryGrid: { display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '8px', marginBottom: '20px' },
      categoryBtn: { display: 'flex', flexDirection: 'column', alignItems: 'center', padding: '10px', border: '1px solid #eee', borderRadius: '12px', background: '#fff' },
      categoryBtnActive: { borderColor: '#6B9DFC', background: '#f0f7ff' },
      categoryBtnText: { fontSize: '11px' },
      inputFull: { width: '100%', padding: '14px', borderRadius: '14px', border: '1px solid #eee', marginTop: '10px', fontSize: '16px' },
      confirmBtn: { width: '100%', padding: '16px', background: '#6B9DFC', color: '#fff', border: 'none', borderRadius: '14px', marginTop: '20px', fontWeight: 'bold' },
      tripListItem: { display: 'flex', justifyContent: 'space-between', padding: '16px', borderBottom: '1px solid #eee' },
      modalCloseBtn: { width: '100%', padding: '14px', background: '#f5f5f5', border: 'none', borderRadius: '14px', marginTop: '10px' }
    };

    const styleSheet = document.createElement('style');
    styleSheet.textContent = `@keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }`;
    document.head.appendChild(styleSheet);

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
