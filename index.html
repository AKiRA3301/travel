<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>æ—…è¡ŒåŸºé‡‘ - Kiki & Luis</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #fdfcfb; }
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
    @keyframes gradient { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // === é…ç½®ä¿¡æ¯ ===
    const SUPABASE_URL = 'https://rmsxbcifpzgtjetoycyj.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_8SBnDUYD0Cr8Ql52MBt2hQ_zBT6y6OW'; 
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const categories = [
      { id: 'daigou', name: 'ä»£è´­', emoji: 'ğŸ›ï¸' },
      { id: 'salary', name: 'å·¥èµ„', emoji: 'ğŸ’°' },
      { id: 'bonus', name: 'å¥–é‡‘', emoji: 'ğŸ' },
      { id: 'hongbao', name: 'çº¢åŒ…', emoji: 'ğŸ§§' },
      { id: 'parttime', name: 'å…¼èŒ', emoji: 'ğŸ’¼' },
      { id: 'sell', name: 'é—²ç½®å‡ºå”®', emoji: 'ğŸ“¦' },
      { id: 'other', name: 'å…¶ä»–', emoji: 'âœ¨' },
    ];

    const users = [
      { id: 'luis', name: 'Luis', emoji: 'ğŸ‘¦', color: '#6B9DFC' },
      { id: 'kiki', name: 'Kiki', emoji: 'ğŸ‘§', color: '#FF8A9B' },
    ];

    function App() {
      const [trips, setTrips] = useState([]);
      const [currentTripId, setCurrentTripId] = useState(null);
      const [showAddModal, setShowAddModal] = useState(false);
      const [showTripModal, setShowTripModal] = useState(false);
      const [showSelectTripModal, setShowSelectTripModal] = useState(false);
      const [isLoading, setIsLoading] = useState(true);
      const [showFireworks, setShowFireworks] = useState(false);
      
      const [newRecord, setNewRecord] = useState({ amount: '', category: 'salary', note: '', user: 'luis' });
      const [newTrip, setNewTrip] = useState({ destination: '', targetAmount: '', icon: 'âœˆï¸' });
      const canvasRef = useRef(null);

      // 1. è·å–æ•°æ®é€»è¾‘
      const loadData = async () => {
        const { data, error } = await supabaseClient.from('trips').select('*').order('id', { ascending: false });
        if (data) {
          setTrips(data);
          if (data.length > 0 && !currentTripId) setCurrentTripId(data[0].id);
        }
        setIsLoading(false);
      };

      // 2. å®æ—¶ç›‘å¬é€»è¾‘
      useEffect(() => {
        loadData();
        const channel = supabaseClient.channel('realtime-trips')
          .on('postgres_changes', { event: '*', schema: 'public', table: 'trips' }, () => loadData())
          .subscribe();
        return () => supabaseClient.removeChannel(channel);
      }, []);

      const currentTrip = trips.find(t => t.id === currentTripId);
      const records = currentTrip?.records || [];
      const totalSaved = records.reduce((sum, r) => sum + Number(r.amount), 0);
      const progress = currentTrip ? Math.min((totalSaved / currentTrip.target_amount) * 100, 100) : 0;

      // 3. ä¸šåŠ¡æ“ä½œ
      const handleAddTrip = async () => {
        if (!newTrip.destination || !newTrip.targetAmount) return;
        const { error } = await supabaseClient.from('trips').insert([{
          id: Date.now(),
          destination: newTrip.destination,
          target_amount: parseFloat(newTrip.targetAmount),
          icon: newTrip.icon,
          records: []
        }]);
        if (!error) { setShowTripModal(false); setNewTrip({ destination: '', targetAmount: '', icon: 'âœˆï¸' }); }
      };

      const handleAddRecord = async () => {
        if (!newRecord.amount || !currentTrip) return;
        const record = {
          id: Date.now(),
          amount: parseFloat(newRecord.amount),
          category: newRecord.category,
          note: newRecord.note,
          user_id: newRecord.user,
          date: new Date().toISOString().split('T')[0]
        };
        const updatedRecords = [record, ...records];
        const { error } = await supabaseClient.from('trips').update({ records: updatedRecords }).eq('id', currentTripId);
        if (!error) { 
          setShowAddModal(false); 
          setNewRecord({ amount: '', category: 'salary', note: '', user: 'luis' });
          if (progress >= 100) setShowFireworks(true);
        }
      };

      const handleDeleteRecord = async (recordId) => {
        const updatedRecords = records.filter(r => r.id !== recordId);
        await supabaseClient.from('trips').update({ records: updatedRecords }).eq('id', currentTripId);
      };

      const handleDeleteTrip = async (id) => {
        if (!confirm('ç¡®å®šåˆ é™¤å—ï¼Ÿ')) return;
        await supabaseClient.from('trips').delete().eq('id', id);
      };

      if (isLoading) return <div style={styles.loadingContainer}><div style={styles.loadingPlane}>âœˆï¸</div><p>åŒæ­¥äº‘ç«¯æ•°æ®...</p></div>;

      return (
        <div style={styles.container}>
          <header style={styles.header}>
            <div style={styles.titleRow}><span style={styles.titlePlane}>âœˆï¸</span><div><h1 style={styles.title}>æ—…è¡ŒåŸºé‡‘</h1><p style={styles.titleEn}>Travel Fund</p></div></div>
            <p style={styles.subtitle}>Kiki & Luis ä¸€èµ·æ”’é’±å»æ—…è¡Œ</p>
          </header>

          <div style={styles.tripSelector}>
            <button style={styles.tripButton} onClick={() => setShowSelectTripModal(true)}>
              <span style={styles.tripIcon}>{currentTrip?.icon || 'ğŸŒ'}</span>
              <span style={styles.tripName}>{currentTrip?.destination || 'é€‰æ‹©è®¡åˆ’'}</span>
              <span style={styles.tripArrow}>â–¼</span>
            </button>
            <button style={styles.addTripBtn} onClick={() => setShowTripModal(true)}>+ æ–°è®¡åˆ’</button>
          </div>

          {currentTrip ? (
            <>
              <section style={styles.progressSection}>
                <div style={styles.progressCard}>
                  <div style={styles.progressHeader}><span style={styles.progressLabel}>è¿›åº¦</span><span style={styles.progressPercent}>{progress.toFixed(1)}%</span></div>
                  <div style={styles.progressBarBg}>
                    <div style={{...styles.progressBarFill, width: `${progress}%`}}></div>
                    <span style={{...styles.progressPlane, left: `calc(${Math.min(progress, 95)}% - 14px)`}}>âœˆï¸</span>
                  </div>
                  <div style={styles.amountRow}>
                    <div style={styles.amountItem}><span style={styles.amountLabel}>å·²å­˜</span><span style={styles.amountValue}>Â¥{totalSaved}</span></div>
                    <span style={styles.amountDivider}>/</span>
                    <div style={styles.amountItem}><span style={styles.amountLabel}>ç›®æ ‡</span><span style={styles.amountValue}>Â¥{currentTrip.target_amount}</span></div>
                  </div>
                </div>
              </section>

              <section style={styles.userSection}>
                <h3 style={styles.sectionTitle}>ğŸ’ª è´¡çŒ®æ¦œ</h3>
                {users.map(u => {
                  const userAmt = records.filter(r => r.user_id === u.id).reduce((s, r) => s + r.amount, 0);
                  return (
                    <div key={u.id} style={styles.userCard}>
                      <span style={{fontSize: 24}}>{u.emoji}</span>
                      <div style={styles.userInfo}><span style={styles.userName}>{u.name}</span><span style={styles.userAmount}>Â¥{userAmt}</span></div>
                      <div style={{...styles.userPercent, color: u.color}}>{totalSaved > 0 ? ((userAmt/totalSaved)*100).toFixed(0) : 0}%</div>
                    </div>
                  );
                })}
              </section>

              <section style={styles.recordsSection}>
                <h3 style={styles.sectionTitle}>ğŸ“‹ æ”¶å…¥è®°å½•</h3>
                <div style={styles.recordsList}>
                  {records.map(r => (
                    <div key={r.id} style={styles.recordItem}>
                      <div style={styles.recordIconBox}>{categories.find(c => c.id === r.category)?.emoji}</div>
                      <div style={styles.recordInfo}>
                        <div style={styles.recordMain}><b>{categories.find(c => c.id === r.category)?.name}</b><small style={{color: users.find(u=>u.id===r.user_id)?.color}}>{r.user_id==='luis'?'ğŸ‘¦':'ğŸ‘§'} {r.user_id}</small></div>
                        <div style={styles.recordMeta}>{r.note && <span>{r.note} Â· </span>}{r.date}</div>
                      </div>
                      <div style={styles.recordRight}>
                        <span style={styles.recordAmount}>+Â¥{r.amount}</span>
                        <button style={styles.deleteBtn} onClick={() => handleDeleteRecord(r.id)}>Ã—</button>
                      </div>
                    </div>
                  ))}
                </div>
              </section>
            </>
          ) : <div style={styles.emptyTrip}><p>è¿˜æ²¡æœ‰è®¡åˆ’ï¼Œç‚¹å‡»â€œ+æ–°è®¡åˆ’â€å¼€å§‹</p></div>}

          {currentTrip && <button style={styles.addButton} onClick={() => setShowAddModal(true)}>ğŸ’° è®°ä¸€ç¬”</button>}

          {/* å„ç§å¼¹çª—é€»è¾‘ */}
          {showAddModal && (
            <div style={styles.modalOverlay} onClick={() => setShowAddModal(false)}>
              <div style={styles.modal} onClick={e => e.stopPropagation()}>
                <h3 style={styles.modalTitle}>è®°ä¸€ç¬”</h3>
                <div style={styles.userSelector}>
                  {users.map(u => (
                    <button key={u.id} onClick={() => setNewRecord({...newRecord, user: u.id})} style={{...styles.userSelectBtn, borderColor: newRecord.user===u.id?u.color:'#eee'}}>{u.emoji} {u.name}</button>
                  ))}
                </div>
                <select style={styles.inputFull} value={newRecord.category} onChange={e=>setNewRecord({...newRecord, category:e.target.value})}>
                  {categories.map(c => <option key={c.id} value={c.id}>{c.emoji} {c.name}</option>)}
                </select>
                <input type="number" placeholder="é‡‘é¢" style={styles.inputFull} value={newRecord.amount} onChange={e=>setNewRecord({...newRecord, amount:e.target.value})} />
                <input type="text" placeholder="å¤‡æ³¨" style={styles.inputFull} value={newRecord.note} onChange={e=>setNewRecord({...newRecord, note:e.target.value})} />
                <div style={styles.modalButtons}>
                  <button style={styles.confirmBtn} onClick={handleAddRecord}>ç¡®è®¤</button>
                </div>
              </div>
            </div>
          )}

          {showTripModal && (
            <div style={styles.modalOverlay} onClick={() => setShowTripModal(false)}>
              <div style={styles.modal} onClick={e => e.stopPropagation()}>
                <h3 style={styles.modalTitle}>æ–°è®¡åˆ’</h3>
                <input type="text" placeholder="ç›®çš„åœ°" style={styles.inputFull} value={newTrip.destination} onChange={e=>setNewTrip({...newTrip, destination:e.target.value})} />
                <input type="number" placeholder="ç›®æ ‡é‡‘é¢" style={styles.inputFull} value={newTrip.targetAmount} onChange={e=>setNewTrip({...newTrip, targetAmount:e.target.value})} />
                <button style={styles.confirmBtn} onClick={handleAddTrip}>åˆ›å»º</button>
              </div>
            </div>
          )}

          {showSelectTripModal && (
            <div style={styles.modalOverlay} onClick={() => setShowSelectTripModal(false)}>
              <div style={styles.modal} onClick={e => e.stopPropagation()}>
                <h3 style={styles.modalTitle}>åˆ‡æ¢è®¡åˆ’</h3>
                {trips.map(t => (
                  <div key={t.id} style={styles.tripListItem} onClick={() => {setCurrentTripId(t.id); setShowSelectTripModal(false);}}>
                    <span>{t.icon} {t.destination}</span>
                    <button style={{border:'none', background:'none'}} onClick={(e)=>{e.stopPropagation(); handleDeleteTrip(t.id);}}>ğŸ—‘ï¸</button>
                  </div>
                ))}
                <button style={styles.modalCloseBtn} onClick={()=>setShowSelectTripModal(false)}>å…³é—­</button>
              </div>
            </div>
          )}
        </div>
      );
    }

    // === æ ·å¼å®šä¹‰ (ä¿ç•™ä½ çš„ç²¾ç¾è®¾è®¡) ===
    const styles = {
      container: { minHeight: '100vh', background: 'linear-gradient(135deg, #E8F4F8 0%, #FFF0F5 100%)', paddingBottom: '100px' },
      loadingContainer: { height: '100vh', display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center' },
      loadingPlane: { fontSize: '48px', animation: 'bounce 1s infinite' },
      header: { padding: '32px 20px 24px' },
      titleRow: { display: 'flex', alignItems: 'center', gap: '12px' },
      title: { fontSize: '28px', fontWeight: '800', background: 'linear-gradient(135deg, #6B9DFC 0%, #FF8A9B 100%)', WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent' },
      subtitle: { display: 'inline-block', marginTop: '8px', padding: '8px 14px', background: 'white', borderRadius: '20px', fontSize: '13px', color: '#7B8794' },
      tripSelector: { display: 'flex', gap: '12px', padding: '0 20px 20px' },
      tripButton: { flex: 1, display: 'flex', alignItems: 'center', padding: '14px', background: 'white', border: '1px solid #eee', borderRadius: '16px' },
      addTripBtn: { padding: '14px', background: '#6B9DFC', color: 'white', border: 'none', borderRadius: '16px' },
      progressSection: { padding: '0 20px 20px' },
      progressCard: { background: 'white', borderRadius: '24px', padding: '24px', boxShadow: '0 8px 32px rgba(0,0,0,0.05)' },
      progressBarBg: { height: '24px', background: '#f0f0f0', borderRadius: '12px', position: 'relative', marginTop: '10px' },
      progressBarFill: { height: '100%', background: 'linear-gradient(90deg, #6B9DFC, #FF8A9B)', borderRadius: '12px' },
      progressPlane: { position: 'absolute', top: '-4px', transition: 'left 0.5s' },
      amountRow: { display: 'flex', justifyContent: 'center', gap: '20px', marginTop: '15px' },
      amountValue: { fontWeight: 'bold', fontSize: '18px' },
      userSection: { padding: '0 20px 20px' },
      userCard: { display: 'flex', alignItems: 'center', padding: '12px', background: 'white', borderRadius: '16px', marginBottom: '10px' },
      userInfo: { flex: 1, marginLeft: '10px' },
      recordsSection: { padding: '0 20px' },
      recordsList: { background: 'white', borderRadius: '20px', overflow: 'hidden' },
      recordItem: { display: 'flex', alignItems: 'center', padding: '14px', borderBottom: '1px solid #f9f9f9' },
      recordIconBox: { width: '40px', height: '40px', background: '#f5f7fa', borderRadius: '10px', display: 'flex', alignItems: 'center', justifyContent: 'center' },
      recordInfo: { flex: 1, marginLeft: '12px' },
      recordAmount: { fontWeight: 'bold', color: '#48BB78' },
      deleteBtn: { marginLeft: '10px', border: 'none', color: '#ff6b6b', background: 'none', fontSize: '18px' },
      addButton: { position: 'fixed', bottom: '24px', left: '50%', transform: 'translateX(-50%)', padding: '16px 32px', background: '#6B9DFC', color: 'white', border: 'none', borderRadius: '50px', fontWeight: 'bold', boxShadow: '0 8px 20px rgba(107,157,252,0.4)' },
      modalOverlay: { position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'flex-end', justifyContent: 'center', zIndex: 100 },
      modal: { background: 'white', padding: '24px', width: '100%', maxWidth: '500px', borderRadius: '24px 24px 0 0' },
      inputFull: { width: '100%', padding: '12px', borderRadius: '10px', border: '1px solid #eee', marginTop: '10px' },
      confirmBtn: { width: '100%', padding: '14px', background: '#6B9DFC', color: 'white', border: 'none', borderRadius: '10px', marginTop: '15px', fontWeight: 'bold' },
      userSelectBtn: { flex: 1, padding: '12px', border: '2px solid #eee', borderRadius: '12px', background: 'white' },
      userSelector: { display: 'flex', gap: '10px', marginBottom: '10px' },
      tripListItem: { padding: '15px', display: 'flex', justifyContent: 'space-between', borderBottom: '1px solid #eee' },
      modalCloseBtn: { width: '100%', padding: '12px', background: '#f5f5f5', border: 'none', borderRadius: '10px', marginTop: '10px' }
    };

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
